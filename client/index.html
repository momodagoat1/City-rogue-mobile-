<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Urban Sandbox — Mobile</title>
  <style>
    :root{--bg:#0e0f12;--fg:#e7e8ea;--accent:#45b7ff;--danger:#ff4d5a;--ok:#28d17c;--muted:#8c93a1}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    canvas{display:block;touch-action:none}
    .hud{position:fixed;inset:0;pointer-events:none}
    .btn{position:fixed;bottom:16vmin;right:6vmin;width:16vmin;height:16vmin;border-radius:50%;background:rgba(255,255,255,.08);backdrop-filter:blur(8px);box-shadow:0 10px 30px rgba(0,0,0,.35);display:grid;place-items:center;font-weight:700;pointer-events:auto;user-select:none}
    .btn:active{transform:scale(.96)}
    .btn.shoot{right:6vmin}
    .btn.dash{right:24vmin}
    .btn>span{font-size:4.5vmin;color:var(--fg)}
    .joystick{position:fixed;left:6vmin;bottom:8vmin;width:30vmin;height:30vmin;border-radius:50%;background:rgba(255,255,255,.06);backdrop-filter:blur(6px);pointer-events:auto}
    .stick{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:14vmin;height:14vmin;border-radius:50%;background:rgba(255,255,255,.2)}
    .banner{position:fixed;top:0;left:0;right:0;padding:10px 14px;background:linear-gradient(180deg,rgba(0,0,0,.6),transparent);font-size:12px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);font-weight:600}
    .muted{color:var(--muted)}
    #fps{position:fixed;top:10px;right:10px;font-size:12px;opacity:.7}
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div class="hud">
    <div class="banner">
      <div>
        <span class="chip">Urban Sandbox</span>
        <span class="muted" id="status">connecting...</span>
      </div>
      <div class="muted">Room: <span id="room"></span> · Players: <span id="pcount">1</span></div>
    </div>
    <div class="joystick" id="joy"><div class="stick" id="stick"></div></div>
    <div class="btn shoot" id="shoot"><span>●</span></div>
    <div class="btn dash" id="dash"><span>➤</span></div>
    <div id="fps"></div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  let W=0,H=0; const resize=()=>{W=innerWidth;H=innerHeight;canvas.width=W*DPR;canvas.height=H*DPR;canvas.style.width=W+'px';canvas.style.height=H+'px';ctx.setTransform(DPR,0,0,DPR,0,0)}; resize(); addEventListener('resize',resize);

  const statusEl=document.getElementById('status');
  const roomEl=document.getElementById('room');
  const pcountEl=document.getElementById('pcount');
  const fpsEl=document.getElementById('fps');

  const ROOM = location.hash.slice(1) || 'lobby';
  roomEl.textContent = ROOM;
  const WS_URL = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
    ? 'ws://localhost:8080'
    : 'wss://YOUR-DEPLOYED-WS-URL';

  const world = { w: 3000, h: 3000, cells: 60 };
  const me = { id: null, x: 1500, y: 1500, vx:0, vy:0, ang:0, speed: 2.4, radius: 16, hp: 100, color: '#45b7ff', lastShot: 0, dashCd: 0 };
  const others = new Map();
  const bullets = new Map();
  let lastNet = 0;

  const joy = document.getElementById('joy');
  const stick = document.getElementById('stick');
  let joyActive=false,joyDx=0,joyDy=0;

  const joyRect=()=>joy.getBoundingClientRect();
  const joyStart=(x,y)=>{joyActive=true; const r=joyRect(); updateStick(x,y)}
  const joyEnd=()=>{joyActive=false; joyDx=joyDy=0; stick.style.left='50%'; stick.style.top='50%'}
  const updateStick=(x,y)=>{const r=joyRect(); const dx=x-(r.left+r.width/2); const dy=y-(r.top+r.height/2); const max=r.width*0.35; const mag=Math.hypot(dx,dy)||1; const cl=Math.min(max,mag); const nx=dx/mag, ny=dy/mag; stick.style.left=`calc(50% + ${nx*cl}px)`; stick.style.top=`calc(50% + ${ny*cl}px)`; joyDx=(dx/max); joyDy=(dy/max)}

  const touchId = {joy:null};
  joy.addEventListener('touchstart',e=>{if(touchId.joy!=null)return; const t=e.changedTouches[0]; touchId.joy=t.identifier; joyStart(t.clientX,t.clientY); e.preventDefault()},{passive:false});
  addEventListener('touchmove',e=>{for(const t of e.changedTouches){if(t.identifier===touchId.joy){updateStick(t.clientX,t.clientY); e.preventDefault()}}},{passive:false});
  addEventListener('touchend',e=>{for(const t of e.changedTouches){if(t.identifier===touchId.joy){touchId.joy=null; joyEnd(); e.preventDefault()}}},{passive:false});

  let firing=false; let dashing=false;
  document.getElementById('shoot').addEventListener('touchstart',e=>{firing=true; e.preventDefault()},{passive:false});
  document.getElementById('shoot').addEventListener('touchend',()=>firing=false);
  document.getElementById('dash').addEventListener('touchstart',e=>{dashing=true; e.preventDefault()},{passive:false});
  document.getElementById('dash').addEventListener('touchend',()=>dashing=false);

  document.addEventListener('gesturestart',e=>e.preventDefault());
  document.addEventListener('touchmove',e=>{if(joyActive||firing||dashing) e.preventDefault()},{passive:false});

  let ws; let connected=false;
  function connect(){
    ws = new WebSocket(WS_URL);
    ws.addEventListener('open',()=>{connected=true; statusEl.textContent='connected'; ws.send(JSON.stringify({t:'join', room:ROOM}));});
    ws.addEventListener('close',()=>{connected=false; statusEl.textContent='reconnecting...'; setTimeout(connect, 1000)});
    ws.addEventListener('message', (ev)=>{
      const msg = JSON.parse(ev.data);
      if(msg.t==='welcome'){ me.id = msg.id; }
      else if(msg.t==='snapshot'){
        const ids = new Set();
        for(const p of msg.players){
          if(p.id===me.id) continue;
          ids.add(p.id);
          let o = others.get(p.id); if(!o){o={...p, lerpX:p.x, lerpY:p.y}; others.set(p.id,o)}
          o.x=p.x; o.y=p.y; o.hp=p.hp; o.color=p.color || '#f3a952';
        }
        for(const [id,o] of [...others]) if(!ids.has(id)) others.delete(id);
        bullets.clear(); for(const b of msg.bullets) bullets.set(b.id,b);
        pcountEl.textContent = msg.count || 1;
      }
      else if(msg.t==='hit' && msg.id===me.id){ me.hp = Math.max(0, me.hp - msg.dmg); if(me.hp<=0){ me.x=1500; me.y=1500; me.hp=100; }}
    });
  }
  connect();

  const buildings=[];
  for(let i=0;i<80;i++){
    const w=80+Math.random()*120,h=80+Math.random()*120,x=100+Math.random()*(world.w-200-w),y=100+Math.random()*(world.h-200-h);
    buildings.push({x,y,w,h});
  }

  function collideRectCircle(rx,ry,rw, rh, cx,cy,cr){
    const nx=Math.max(rx,Math.min(cx,rx+rw)); const ny=Math.max(ry,Math.min(cy,ry+rh));
    const dx=cx-nx, dy=cy-ny; return (dx*dx+dy*dy) <= cr*cr;
  }

  function step(dt){
    const mag = Math.hypot(joyDx,joyDy);
    const nx = mag>0.1 ? joyDx/mag : 0;
    const ny = mag>0.1 ? joyDy/mag : 0;
    const speed = me.speed * (dashing?2.1:1);
    me.vx = nx * speed * 60 * dt;
    me.vy = ny * speed * 60 * dt;
    me.ang = Math.atan2(ny, nx);

    let nxpos = me.x + me.vx; let nypos = me.y + me.vy;
    let tx=nxpos, ty=me.y; for(const b of buildings){ if(collideRectCircle(b.x,b.y,b.w,b.h, tx,ty, me.radius)){ me.vx=0; tx=me.x; } }
    let ty2=nypos, tx2=tx; for(const b of buildings){ if(collideRectCircle(b.x,b.y,b.w,b.h, tx2,ty2, me.radius)){ me.vy=0; ty2=me.y; } }
    me.x = Math.max(me.radius, Math.min(world.w-me.radius, tx2));
    me.y = Math.max(me.radius, Math.min(world.h-me.radius, ty2));

    if(firing && performance.now() - me.lastShot > 220){
      me.lastShot = performance.now();
      const dirx = Math.cos(me.ang), diry = Math.sin(me.ang);
      const bullet = {id: 'c'+Math.random().toString(36).slice(2), x: me.x+dirx*20, y: me.y+diry*20, vx: dirx*7, vy: diry*7, owner: me.id};
      bullets.set(bullet.id, bullet);
      if(connected) ws.send(JSON.stringify({t:'shoot', b:{x:bullet.x,y:bullet.y,vx:bullet.vx,vy:bullet.vy}}));
    }

    if(connected){
      const t=performance.now();
      if(t-lastNet>50){ lastNet=t; ws.send(JSON.stringify({t:'state', p:{x:me.x,y:me.y,ang:me.ang,hp:me.hp,room:ROOM}})); }
    }

    for(const o of others.values()){
      const k=0.15; o.lerpX += (o.x - o.lerpX)*k; o.lerpY += (o.y - o.lerpY)*k;
    }

    for(const b of bullets.values()){
      b.x += b.vx * 60 * dt; b.y += b.vy * 60 * dt;
      if(b.x<0||b.y<0||b.x>world.w||b.y>world.h) bullets.delete(b.id);
    }
  }

  function draw(){
    const cx = Math.floor(me.x - W/2); const cy = Math.floor(me.y - H/2);
    ctx.clearRect(0,0,W,H);
    ctx.save(); ctx.translate(-cx,-cy);
    ctx.fillStyle = '#1a1c22'; ctx.fillRect(cx, cy, W, H);
    ctx.strokeStyle = '#2a2e37'; ctx.lineWidth = 1;
    const step = world.w / world.cells;
    for(let x=0;x<=world.w;x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,world.h); ctx.stroke(); }
    for(let y=0;y<=world.h;y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(world.w,y); ctx.stroke(); }
    ctx.fillStyle = '#262a33';
    for(const b of buildings){ ctx.fillRect(b.x,b.y,b.w,b.h); }
    ctx.fillStyle = '#ffd166';
    for(const b of bullets.values()){ ctx.beginPath(); ctx.arc(b.x,b.y,4,0,Math.PI*2); ctx.fill(); }
    for(const o of others.values()){ drawPlayer(o.lerpX,o.lerpY,o.ang || 0,o.color || '#f3a952', o.hp); }
    drawPlayer(me.x, me.y, me.ang, me.color, me.hp, true);
    ctx.restore();
    ctx.save();
    const w= W*0.4, h=8, x=(W-w)/2, y=H-22;
    ctx.fillStyle='rgba(255,255,255,.1)'; ctx.fillRect(x,y,w,h);
    ctx.fillStyle= me.hp>60? '#28d17c' : me.hp>30? '#f3a952' : '#ff4d5a';
    ctx.fillRect(x,y,w*(me.hp/100),h);
    ctx.restore();
  }

  function drawPlayer(x,y,ang,color,hp,isMe=false){
    ctx.save(); ctx.translate(x,y); ctx.rotate(ang);
    ctx.fillStyle = color; ctx.beginPath(); ctx.arc(0,0,16,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#000'; ctx.fillRect(8,-3,10,6);
    ctx.rotate(-ang); ctx.fillStyle='rgba(0,0,0,.5)'; ctx.fillRect(-18,-28,36,6); ctx.fillStyle='#7dffb1'; ctx.fillRect(-18,-28,36*(hp/100),6);
    if(isMe){ ctx.strokeStyle='#45b7ff'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,0,20,0,Math.PI*2); ctx.stroke(); }
    ctx.restore();
  }

  let last=performance.now();
  function loop(){
    const now=performance.now(); const dt=Math.min(0.033,(now-last)/1000); last=now;
    step(dt); draw();
    requestAnimationFrame(loop);
  }
  loop();
})();
</script>
</body>
      </html>
